{% extends "epilepsy/base_epilepsy.html" %}

{% block title %}æµè§ˆæ‚£è€… - ç™«ç—«æ•°æ®é›†{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">æµè§ˆæ‚£è€…</h3>

  <!-- æœç´¢è¡¨å• -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <input type="text"
             name="q"
             value="{{ q }}"
             class="form-control"
             placeholder="æœç´¢æ‚£è€…å§“å / ç§‘å®¤ / åºŠå·">
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">æœç´¢</button>
    </div>
    {% if q %}
    <div class="col-auto">
      <a href="{% url 'epilepsy:patient_list' %}" class="btn btn-outline-secondary">
        æ¸…é™¤
      </a>
    </div>
    {% endif %}
  </form>

  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>æ‚£è€…å§“å</th>
        <th>æ€§åˆ«</th>
        <th>ç”Ÿæ—¥</th>
        <th>åºŠå·</th>
        <th>å…¥é™¢æ—¶é—´</th>
        <th>æ“ä½œ</th>
        <th>ä¸‹è½½</th>
      </tr>
    </thead>
    <tbody>
      {% for p in patients %}
      <tr>
        <td>{{ p.name }}</td>
        <td>{{ p.get_gender_display }}</td>
        <td>{{ p.birthday }}</td>
        <td>{{ p.bed_number }}</td>
        <td>{{ p.admission_date }}</td>
        <td>
          {% if user.is_authenticated %}
            {% if user.profile.role == 'ADMIN' or user.profile.role == 'STAFF' %}
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-edit-url="{% url 'epilepsy:patient_edit' p.id %}"
                onclick="openEditPanel({{ p.id }})">
                ä¿®æ”¹
              </button>
              <form method="post"
                    action="{% url 'epilepsy:patient_delete' p.id %}"
                    style="display:inline;">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('ç¡®è®¤åˆ é™¤è¯¥æ‚£è€…ï¼Ÿ');">
                  åˆ é™¤
                </button>
              </form>
            {% endif %}
          {% else %}
            <span class="text-muted">åªè¯»</span>
          {% endif %}
        </td>

        <td>
          {% if p.datasets.all %}
            <a href="{% url 'epilepsy:patient_datasets' p.id %}"
               class="btn btn-sm btn-outline-success">
              ä¸‹è½½æ•°æ®
            </a>
          {% else %}
            <span class="text-muted">æš‚æ— æ•°æ®</span>
          {% endif %}
        </td>

      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted">æš‚æ— æ‚£è€…</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- åˆ†é¡µ -->
  {% if patients.paginator.num_pages > 1 %}
  <nav aria-label="æ‚£è€…åˆ†é¡µ">
    <ul class="pagination">
      {% if patients.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">
          ä¸Šä¸€é¡µ
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">ä¸Šä¸€é¡µ</span>
      </li>
      {% endif %}

      {% for num in patients.paginator.page_range %}
        {% if num == patients.number %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > patients.number|add:"-3" and num < patients.number|add:"3" %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if patients.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.next_page_number }}{% if q %}&q={{ q }}{% endif %}">
          ä¸‹ä¸€é¡µ
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">ä¸‹ä¸€é¡µ</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- å·¦ä¾§æ»‘å‡ºç¼–è¾‘é¢æ¿ï¼ˆè‡ªå®šä¹‰ drawerï¼Œä¸ä¾èµ– Bootstrap Offcanvasï¼‰ -->
<style>
  /* èƒŒæ™¯é®ç½© */
  #editPatientBackdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, .5);
    opacity: 0;
    visibility: hidden;
    transition: opacity .3s ease;
    z-index: 1040;
  }
  #editPatientBackdrop.show {
    opacity: 1;
    visibility: visible;
  }

  /* å³ä¾§æ»‘å‡ºçš„é¢æ¿ */
  #editPatientDrawer {
    position: fixed;
    top: 0;
    right: 0;               /* ğŸ‘ˆ æ”¹æˆ right: 0 */
    height: 100%;
    width: 70%;
    max-width: 900px;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,.3);
    transform: translateX(100%);  /* ğŸ‘ˆ åˆå§‹åœ¨å±å¹•å³å¤–ä¾§ */
    transition: transform .3s ease;
    z-index: 1050;
    display: flex;
    flex-direction: column;
  }
  #editPatientDrawer.show {
    transform: translateX(0);     /* ğŸ‘ˆ æ˜¾ç¤ºæ—¶æ»‘å…¥ */
  }



  #editPatientDrawer .drawer-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
  }
  #editPatientDrawer .drawer-body {
    padding: 1rem 1.5rem;
    overflow-y: auto;
  }
</style>

<div id="editPatientBackdrop"></div>

<div id="editPatientDrawer">
  <div class="drawer-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">ä¿®æ”¹æ‚£è€…</h5>
    <button type="button" class="close" aria-label="å…³é—­" onclick="closeEditPanel()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="drawer-body" id="editPatientBody">
    <div class="text-center text-muted">è¯·é€‰æ‹©è¦ä¿®æ”¹çš„æ‚£è€…</div>
  </div>
</div>

<script>
  function openEditPanel(patientId) {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    const body = document.getElementById('editPatientBody');

    // æ‰“å¼€é¢æ¿ + é®ç½©
    drawer.classList.add('show');
    backdrop.classList.add('show');

    body.innerHTML = '<div class="text-center text-muted">åŠ è½½ä¸­...</div>';

    const url = `/epilepsy/patients/${patientId}/edit/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;       // æ¸²æŸ“ patient_form_partial.html
        attachEditFormHandler(url);  // ç»‘å®šè¡¨å•æäº¤
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">åŠ è½½å¤±è´¥</div>';
      });
  }

  function closeEditPanel() {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    drawer.classList.remove('show');
    backdrop.classList.remove('show');
  }

  // ç‚¹å‡»é®ç½©ä¹Ÿå…³é—­
  document.getElementById('editPatientBackdrop')
          .addEventListener('click', closeEditPanel);

  // ç»‘å®šé¢æ¿ä¸­è¡¨å•çš„ AJAX æäº¤é€»è¾‘
  function attachEditFormHandler(url) {
    const body = document.getElementById('editPatientBody');
    const form = body.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
      const csrfToken = csrfInput ? csrfInput.value : '';

      fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken
        }
      })
        .then(response => {
          const contentType = response.headers.get('content-type') || '';
          if (contentType.indexOf('application/json') !== -1) {
            return response.json();
          }
          return response.text();
        })
        .then(data => {
          // åç«¯è¿”å› JSONï¼šä¿å­˜æˆåŠŸ
          if (typeof data === 'object' && data.success) {
            closeEditPanel();
            // åˆ·æ–°åˆ—è¡¨ï¼Œçœ‹åˆ°æœ€æ–°æ•°æ®
            window.location.reload();
          }
          // åç«¯è¿”å› HTMLï¼šæ ¡éªŒå¤±è´¥ï¼ŒæŠŠå¸¦é”™è¯¯ä¿¡æ¯çš„è¡¨å•é‡æ–°æ”¾è¿› drawer
          else if (typeof data === 'string') {
            body.innerHTML = data;
            attachEditFormHandler(url);
          }
        })
        .catch(err => {
          console.error(err);
          alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        });
    }, { once: true });
  }
</script>

{% endblock %}

