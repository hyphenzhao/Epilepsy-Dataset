{% extends "epilepsy/base_epilepsy.html" %}

{% block title %}浏览患者 - 癫痫数据集{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">浏览患者</h3>

  <!-- 搜索表单 -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <input type="text"
             name="q"
             value="{{ q }}"
             class="form-control"
             placeholder="搜索患者姓名 / 科室 / 床号">
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">搜索</button>
    </div>
    {% if q %}
    <div class="col-auto">
      <a href="{% url 'epilepsy:patient_list' %}" class="btn btn-outline-secondary">
        清除
      </a>
    </div>
    {% endif %}
  </form>

  <table class="table table-striped table-hover align-middle">
    <thead>
      <tr>
        <th>患者姓名</th>
        <th>性别</th>
        <th>生日</th>
        <th>床号</th>
        <th>入院时间</th>
        <th>操作</th>
        <th>下载</th>
      </tr>
    </thead>
<tbody>
  {% for p in patients %}
  <tr class="patient-row" onclick="openViewPanel({{ p.id }})">
    <td>{{ p.name }}</td>
    <td>{{ p.get_gender_display }}</td>
    <td>{{ p.birthday }}</td>
    <td>{{ p.bed_number }}</td>
    <td>{{ p.admission_date }}</td>
    <td>
      {% if user.is_authenticated %}
        {% if user.profile.role == 'ADMIN' or user.profile.role == 'STAFF' %}
          <button class="btn btn-sm btn-outline-primary"
                  onclick="event.stopPropagation(); openEditPanel({{ p.id }});">
            修改
          </button>
          <form method="post"
                action="{% url 'epilepsy:patient_delete' p.id %}"
                style="display:inline;">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger"
                    onclick="event.stopPropagation(); return confirm('确认删除该患者？');">
              删除
            </button>
          </form>
        {% endif %}
      {% else %}
        <span class="text-muted">只读</span>
      {% endif %}
    </td>
    <td>
      {% if p.datasets.all %}
        <a href="{% url 'epilepsy:patient_datasets' p.id %}"
           class="btn btn-sm btn-outline-success"
           onclick="event.stopPropagation();">
          下载数据
        </a>
      {% else %}
        <span class="text-muted">暂无数据</span>
      {% endif %}
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="6" class="text-center text-muted">暂无患者</td>
  </tr>
  {% endfor %}
</tbody>

  </table>

  <!-- 分页 -->
  {% if patients.paginator.num_pages > 1 %}
  <nav aria-label="患者分页">
    <ul class="pagination">
      {% if patients.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">
          上一页
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">上一页</span>
      </li>
      {% endif %}

      {% for num in patients.paginator.page_range %}
        {% if num == patients.number %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > patients.number|add:"-3" and num < patients.number|add:"3" %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if patients.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.next_page_number }}{% if q %}&q={{ q }}{% endif %}">
          下一页
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">下一页</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- 左侧滑出编辑面板（自定义 drawer，不依赖 Bootstrap Offcanvas） -->
<style>
  /* 行悬停时略微浮起 */
  .patient-row {
    transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
    cursor: pointer;
  }
  .patient-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,.06);
    background-color: #f8f9fe;
  }

  /* 背景遮罩 */
  #editPatientBackdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, .5);
    opacity: 0;
    visibility: hidden;
    transition: opacity .3s ease;
    z-index: 1040;
  }
  #editPatientBackdrop.show {
    opacity: 1;
    visibility: visible;
  }

  /* 右侧滑出的抽屉（编辑 + 查看共用） */
  #editPatientDrawer {
    position: fixed;
    top: 0;
    right: 0;              /* 右侧 */
    height: 100%;
    width: 70%;
    max-width: 900px;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,.3);
    transform: translateX(100%);    /* 初始藏在右边 */
    transition: transform .3s ease;
    z-index: 1050;
    display: flex;
    flex-direction: column;
  }
  #editPatientDrawer.show {
    transform: translateX(0);       /* 显示时滑入 */
  }

  #editPatientDrawer .drawer-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
  }
  #editPatientDrawer .drawer-body {
    padding: 1rem 1.5rem;
    overflow-y: auto;
  }
</style>

<div id="editPatientBackdrop"></div>

<div id="editPatientDrawer">
  <div class="drawer-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0" id="editPatientDrawerTitle">修改患者</h5>
    <button type="button" class="close" aria-label="关闭" onclick="closeEditPanel()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="drawer-body" id="editPatientBody">
    <div class="text-center text-muted">请选择要查看的患者</div>
  </div>
</div>


<script>
  function showDrawer() {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    drawer.classList.add('show');
    backdrop.classList.add('show');
  }

  function closeEditPanel() {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    drawer.classList.remove('show');
    backdrop.classList.remove('show');
  }

  // 点击遮罩关闭
  document.getElementById('editPatientBackdrop')
          .addEventListener('click', closeEditPanel);

  // 点击「修改」按钮 -> 可编辑表单（沿用 patient_form_partial.html）
  function openEditPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '修改患者';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/edit/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;       // 载入 patient_form_partial.html
        attachEditFormHandler(url);  // 绑定保存
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }

  // 点击整行 -> 只读详情
  function openViewPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '患者详情';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/detail/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;   // 这里是只读模板，不需要绑定表单
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }

  // 编辑表单的 AJAX 提交（沿用你同事的 patient_form_partial.html）
  function attachEditFormHandler(url) {
    const body = document.getElementById('editPatientBody');
    const form = body.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
      const csrfToken = csrfInput ? csrfInput.value : '';

      fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken
        }
      })
        .then(response => {
          const contentType = response.headers.get('content-type') || '';
          if (contentType.indexOf('application/json') !== -1) {
            return response.json();
          }
          return response.text();
        })
        .then(data => {
          if (typeof data === 'object' && data.success) {
            closeEditPanel();
            window.location.reload();
          } else if (typeof data === 'string') {
            body.innerHTML = data;
            attachEditFormHandler(url);
          }
        })
        .catch(err => {
          console.error(err);
          alert('保存失败，请稍后再试');
        });
    }, { once: true });
  }
</script>


{% endblock %}

