{% extends "epilepsy/base_epilepsy.html" %}

{% block title %}浏览患者 - 癫痫数据集{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">浏览患者</h3>

  <!-- 搜索表单 -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <input type="text"
             name="q"
             value="{{ q }}"
             class="form-control"
             placeholder="搜索患者姓名 / 科室 / 床号">
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">搜索</button>
    </div>
    {% if q %}
    <div class="col-auto">
      <a href="{% url 'epilepsy:patient_list' %}" class="btn btn-outline-secondary">
        清除
      </a>
    </div>
    {% endif %}
  </form>

  <table class="table table-striped table-hover align-middle">
    <thead>
      <tr>
        <th>患者姓名</th>
        <th>性别</th>
        <th>生日</th>
        <th>床号</th>
        <th>入院时间</th>
        <th>操作</th>
        <th>下载</th>
      </tr>
    </thead>
<tbody>
  {% for p in patients %}
  <tr class="patient-row" onclick="openViewPanel({{ p.id }})">
    <td>{{ p.name }}</td>
    <td>{{ p.get_gender_display }}</td>
    <td>{{ p.birthday }}</td>
    <td>{{ p.bed_number }}</td>
    <td>{{ p.admission_date }}</td>
    <td>
      {% if user.is_authenticated %}
        {% if user.profile.role == 'ADMIN' or user.profile.role == 'STAFF' %}
          <button class="btn btn-sm btn-outline-primary"
                  onclick="event.stopPropagation(); openEditPanel({{ p.id }});">
            修改
          </button>
          <form method="post"
                action="{% url 'epilepsy:patient_delete' p.id %}"
                style="display:inline;">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger"
                    onclick="event.stopPropagation(); return confirm('确认删除该患者？');">
              删除
            </button>
          </form>
        {% endif %}
      {% else %}
        <span class="text-muted">只读</span>
      {% endif %}
    </td>
    <td>
      {# 如果有任意 MRI / PET / EEG / SEEG 文件，则显示“下载管理”按钮 #}
      {% if p.mri_files.exists or p.pet_files.exists or p.eeg_files.exists or p.seeg_files.exists %}
        <button class="btn btn-sm btn-outline-success"
                onclick="event.stopPropagation(); openDownloadPanel({{ p.id }});">
          下载管理
        </button>
      {% elif p.datasets.all %}
        {# 否则如果还有旧的数据集接口，保留原来的“下载数据”入口 #}
        <a href="{% url 'epilepsy:patient_datasets' p.id %}"
           class="btn btn-sm btn-outline-secondary"
           onclick="event.stopPropagation();">
          下载数据
        </a>
      {% else %}
        <span class="text-muted">暂无数据</span>
      {% endif %}
    </td>

  </tr>
  {% empty %}
  <tr>
    <td colspan="6" class="text-center text-muted">暂无患者</td>
  </tr>
  {% endfor %}
</tbody>

  </table>

  <!-- 分页 -->
  {% if patients.paginator.num_pages > 1 %}
  <nav aria-label="患者分页">
    <ul class="pagination">
      {% if patients.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">
          上一页
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">上一页</span>
      </li>
      {% endif %}

      {% for num in patients.paginator.page_range %}
        {% if num == patients.number %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > patients.number|add:"-3" and num < patients.number|add:"3" %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if patients.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.next_page_number }}{% if q %}&q={{ q }}{% endif %}">
          下一页
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">下一页</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- 左侧滑出编辑面板（自定义 drawer，不依赖 Bootstrap Offcanvas） -->
<style>
  /* 行悬停时略微浮起 */
  .patient-row {
    transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
    cursor: pointer;
  }
  .patient-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,.06);
    background-color: #f8f9fe;
  }

  /* 背景遮罩 */
  #editPatientBackdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, .5);
    opacity: 0;
    visibility: hidden;
    transition: opacity .3s ease;
    z-index: 1040;
  }
  #editPatientBackdrop.show {
    opacity: 1;
    visibility: visible;
  }

  /* 右侧滑出的抽屉（编辑 + 查看共用） */
  #editPatientDrawer {
    position: fixed;
    top: 0;
    right: 0;              /* 右侧 */
    height: 100%;
    width: 70%;
    max-width: 900px;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,.3);
    transform: translateX(100%);    /* 初始藏在右边 */
    transition: transform .3s ease;
    z-index: 1050;
    display: flex;
    flex-direction: column;
  }
  #editPatientDrawer.show {
    transform: translateX(0);       /* 显示时滑入 */
  }

  #editPatientDrawer .drawer-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
  }
  #editPatientDrawer .drawer-body {
    padding: 1rem 1.5rem;
    overflow-y: auto;
  }
</style>

<div id="editPatientBackdrop"></div>

<div id="editPatientDrawer">
  <div class="drawer-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0" id="editPatientDrawerTitle">修改患者</h5>
    <button type="button" class="close" aria-label="关闭" onclick="closeEditPanel()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="drawer-body" id="editPatientBody">
    <div class="text-center text-muted">请选择要查看的患者</div>
  </div>
</div>


<script>
  function showDrawer() {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    drawer.classList.add('show');
    backdrop.classList.add('show');
  }

  function closeEditPanel() {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    drawer.classList.remove('show');
    backdrop.classList.remove('show');
  }

  // 点击遮罩关闭
  document.getElementById('editPatientBackdrop')
          .addEventListener('click', closeEditPanel);

  // ================== 只读详情（不改） ==================
  function openViewPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '患者详情';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/detail/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;   // 只读模板
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }

  // ================== 初始化“添加文件 / 删除”UI ==================
  function initLargeFileUploadUI(form) {
    if (!form) return;

    // 检查当前 form 中是否有待上传文件
    form._hasFilesToUpload = function() {
      var names = ['mri_files', 'pet_files', 'eeg_files', 'seeg_files'];
      for (var i = 0; i < names.length; i++) {
        var input = form.querySelector('input[name="' + names[i] + '"]');
        if (input && input.files && input.files.length > 0) {
          return true;
        }
      }
      return false;
    };

    // “添加文件”按钮 -> 触发隐藏的 <input type="file">
    form.querySelectorAll('.js-add-file-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var sel = btn.getAttribute('data-input-selector');
        var input = form.querySelector(sel);
        if (input) {
          input.click();
        }
      });
    });

    // 某一类文件 input 变更时，在对应表格添加“待上传”行
    function bindFileInput(fieldType) {
      var inputName = fieldType + '_files';
      var input = form.querySelector('input[name="' + inputName + '"]');
      var tbody = form.querySelector('tbody[data-file-type="' + fieldType + '"]');
      if (!input || !tbody) return;

      input.addEventListener('change', function() {
        var files = Array.from(input.files || []);
        if (!files.length) return;

        var emptyRow = tbody.querySelector('.js-empty-row');
        if (emptyRow) {
          emptyRow.parentNode.removeChild(emptyRow);
        }

        files.forEach(function(f) {
          var tr = document.createElement('tr');
          tr.setAttribute('data-new-file', '1');
          tr.innerHTML =
            '<td>' + f.name + '</td>' +
            '<td>待上传</td>' +
            '<td>—</td>' +
            '<td><button type="button" class="btn btn-sm btn-outline-danger js-row-remove">删除</button></td>';
          tbody.appendChild(tr);
        });
      });
    }

    ['mri', 'pet', 'eeg', 'seeg'].forEach(bindFileInput);

    // 删除按钮：已有记录 -> 记录到 delete_xxx_file_ids；新添加的 -> 直接从表格删
    form.addEventListener('click', function(evt) {
      var target = evt.target;
      if (!target.classList.contains('js-row-remove')) return;

      var tr = target.closest('tr');
      if (!tr) return;

      var fileId = tr.getAttribute('data-file-id');
      var tbody = tr.closest('tbody');
      var type = tbody ? tbody.getAttribute('data-file-type') : null;

      if (fileId && type) {
        var hiddenName = 'delete_' + type + '_file_ids';
        var hidden = form.querySelector('input[name="' + hiddenName + '"]');
        if (hidden) {
          var current = hidden.value ? hidden.value.split(',') : [];
          if (current.indexOf(fileId) === -1) {
            current.push(fileId);
          }
          hidden.value = current.join(',');
        }
      }

      tr.parentNode.removeChild(tr);
    });
  }

  // ================== 编辑抽屉：载入可编辑表单 ==================
  function openEditPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '修改患者';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/edit/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;       // 载入 patient_form_partial.html
        attachEditFormHandler(url);  // 绑定保存 + 大文件上传
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }
  
  // ================== 下载管理抽屉：显示各类大文件列表 ==================
  function openDownloadPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '下载管理';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/files/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;   // 只读文件列表
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }

  // ================== 编辑表单的 AJAX + 上传进度条 ==================

  // ================== 编辑表单的 AJAX + 上传进度条 ==================
  function attachEditFormHandler(url) {
    const body = document.getElementById('editPatientBody');
    const form = body.querySelector('form');
    if (!form) return;

    // 初始化 “添加文件/删除” 相关 UI
    initLargeFileUploadUI(form);

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      var hasFiles = form._hasFilesToUpload ? form._hasFilesToUpload() : false;
      var modalEl = document.getElementById('uploadProgressModal');
      var progressBar = document.getElementById('uploadProgressBar');

      // 有待上传文件 -> 弹出阻塞窗口（依赖 Bootstrap + jQuery）
      if (hasFiles && modalEl && typeof $ !== 'undefined' && $.fn.modal) {
        $(modalEl).modal('show');
        if (progressBar) {
          progressBar.style.width = '0%';
          progressBar.textContent = '0%';
        }
      }

      var xhr = new XMLHttpRequest();
      xhr.open('POST', url);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

      // CSRF
      var csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
      var csrfToken = csrfInput ? csrfInput.value : '';
      if (csrfToken) {
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
      }

      // 上传进度
      xhr.upload.addEventListener('progress', function (ev) {
        if (!hasFiles || !ev.lengthComputable || !progressBar) return;
        var percent = Math.round((ev.loaded / ev.total) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
      });

      xhr.onreadystatechange = function () {
        if (xhr.readyState !== 4) return;

        if (hasFiles && modalEl && typeof $ !== 'undefined' && $.fn.modal) {
          $(modalEl).modal('hide');
        }

        if (xhr.status >= 200 && xhr.status < 300) {
          var contentType = xhr.getResponseHeader('content-type') || '';
          // ✅ 成功：后端返回 JSON {"success": true}
          if (contentType.indexOf('application/json') !== -1) {
            var data = {};
            try {
              data = JSON.parse(xhr.responseText || '{}');
            } catch (e) {
              data = {};
            }
            if (data.success) {
              window.alert('保存成功');
              // 这里可以根据需要选择是否刷新列表页面
              // window.location.reload();
              closeEditPanel();
            } else {
              window.alert('保存失败，请检查表单。');
            }
          }
          // ❌ 表单校验失败：后端重新渲染了 patient_form_partial.html
          else {
            body.innerHTML = xhr.responseText;
            // 重新绑定（包括“添加文件”按钮）
            attachEditFormHandler(url);
          }
        } else {
          window.alert('上传失败，HTTP 状态码: ' + xhr.status);
        }
      };

      var formData = new FormData(form);
      xhr.send(formData);
    }, { once: true });
  }
</script>



{% endblock %}

