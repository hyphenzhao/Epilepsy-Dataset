{% extends "epilepsy/base_epilepsy.html" %}
{% load static %}
{% block title %}浏览患者 - 癫痫数据集{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'assets/css/image_preview_lightbox.css' %}">
{% endblock %}

{% block epilepsy_content %}
<div class="container mt-4">
  <h3 class="mb-3">浏览患者</h3>

  <!-- 搜索表单 -->
  <!-- 搜索 + 高级搜索表单（同一个 GET form） -->
  <form method="get" class="mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <input type="text"
               name="q"
               value="{{ q }}"
               class="form-control"
               placeholder="搜索患者姓名 / 科室 / 床号">
      </div>
      <div class="col-auto">
        <button class="btn btn-outline-primary" type="submit">搜索</button>
      </div>
      {% if q %}
      <div class="col-auto">
        <a href="{% url 'epilepsy:patient_list' %}" class="btn btn-outline-secondary">
          清除关键字
        </a>
      </div>
      {% endif %}
      <div class="col-auto">
        <!-- 高级搜索折叠开关 -->
        <button class="btn btn-outline-secondary advanced-toggle"
                type="button"
                data-toggle="collapse"
                data-target="#advancedSearch"
                aria-expanded="{% if advanced_open %}true{% else %}false{% endif %}"
                aria-controls="advancedSearch">
          高级搜索
        </button>
      </div>
    </div>

    <!-- 高级搜索面板 -->
    <div class="collapse mt-3 {% if advanced_open %}show{% endif %}" id="advancedSearch">
      <div class="card card-body">
        <div class="row g-3">
          <!-- 入院时间范围 -->
          <div class="col-md-3">
            <label class="form-label small text-muted">入院时间 从</label>
            <input type="date"
                   name="admission_start"
                   value="{{ admission_start }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">入院时间 至</label>
            <input type="date"
                   name="admission_end"
                   value="{{ admission_end }}"
                   class="form-control">
          </div>

          <!-- 评估时间范围 -->
          <div class="col-md-3">
            <label class="form-label small text-muted">评估时间 从</label>
            <input type="date"
                   name="evaluation_start"
                   value="{{ evaluation_start }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">评估时间 至</label>
            <input type="date"
                   name="evaluation_end"
                   value="{{ evaluation_end }}"
                   class="form-control">
          </div>

          <!-- 年龄范围 -->
          <div class="col-md-3">
            <label class="form-label small text-muted">年龄 ≥</label>
            <input type="number"
                   name="age_min"
                   value="{{ age_min }}"
                   min="0"
                   class="form-control"
                   placeholder="最小年龄">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">年龄 ≤</label>
            <input type="number"
                   name="age_max"
                   value="{{ age_max }}"
                   min="0"
                   class="form-control"
                   placeholder="最大年龄">
          </div>

          <!-- 自然发作状态 / 先兆 -->
          <div class="col-md-3">
            <label class="form-label small text-muted">自然发作状态</label>
            <select name="natural_state" class="form-control">
              <option value="">全部</option>
              <option value="1" {% if natural_state == "1" %}selected{% endif %}>有</option>
              <option value="0" {% if natural_state == "0" %}selected{% endif %}>无</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">先兆</label>
            <select name="aura" class="form-control">
              <option value="">全部</option>
              <option value="1" {% if aura == "1" %}selected{% endif %}>有</option>
              <option value="0" {% if aura == "0" %}selected{% endif %}>无</option>
            </select>
          </div>

          <!-- MoCA / HAMA -->
          <div class="col-md-3">
            <label class="form-label small text-muted">MoCA ≥</label>
            <input type="number"
                   step="0.1"
                   name="moca_min"
                   value="{{ moca_min }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">MoCA ≤</label>
            <input type="number"
                   step="0.1"
                   name="moca_max"
                   value="{{ moca_max }}"
                   class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label small text-muted">HAMA ≥</label>
            <input type="number"
                   step="0.1"
                   name="hama_min"
                   value="{{ hama_min }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">HAMA ≤</label>
            <input type="number"
                   step="0.1"
                   name="hama_max"
                   value="{{ hama_max }}"
                   class="form-control">
          </div>

          <!-- HAMD / BAI -->
          <div class="col-md-3">
            <label class="form-label small text-muted">HAMD ≥</label>
            <input type="number"
                   step="0.1"
                   name="hamd_min"
                   value="{{ hamd_min }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">HAMD ≤</label>
            <input type="number"
                   step="0.1"
                   name="hamd_max"
                   value="{{ hamd_max }}"
                   class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label small text-muted">BAI ≥</label>
            <input type="number"
                   step="0.1"
                   name="bai_min"
                   value="{{ bai_min }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">BAI ≤</label>
            <input type="number"
                   step="0.1"
                   name="bai_max"
                   value="{{ bai_max }}"
                   class="form-control">
          </div>

          <!-- BDI / 癫痫量表评分 -->
          <div class="col-md-3">
            <label class="form-label small text-muted">BDI ≥</label>
            <input type="number"
                   step="0.1"
                   name="bdi_min"
                   value="{{ bdi_min }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">BDI ≤</label>
            <input type="number"
                   step="0.1"
                   name="bdi_max"
                   value="{{ bdi_max }}"
                   class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label small text-muted">癫痫量表评分 ≥</label>
            <input type="number"
                   step="0.1"
                   name="epilepsy_scale_min"
                   value="{{ epilepsy_scale_min }}"
                   class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">癫痫量表评分 ≤</label>
            <input type="number"
                   step="0.1"
                   name="epilepsy_scale_max"
                   value="{{ epilepsy_scale_max }}"
                   class="form-control">
          </div>

          <!-- 是否有 MRI / PET / EEG / sEEG 文件 -->
          <div class="col-md-3">
            <label class="form-label small text-muted">MRI 文件</label>
            <select name="has_mri" class="form-control">
              <option value="">全部</option>
              <option value="1" {% if has_mri == "1" %}selected{% endif %}>有</option>
              <option value="0" {% if has_mri == "0" %}selected{% endif %}>无</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">PET 文件</label>
            <select name="has_pet" class="form-control">
              <option value="">全部</option>
              <option value="1" {% if has_pet == "1" %}selected{% endif %}>有</option>
              <option value="0" {% if has_pet == "0" %}selected{% endif %}>无</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">EEG 文件</label>
            <select name="has_eeg" class="form-control">
              <option value="">全部</option>
              <option value="1" {% if has_eeg == "1" %}selected{% endif %}>有</option>
              <option value="0" {% if has_eeg == "0" %}selected{% endif %}>无</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">sEEG 文件</label>
            <select name="has_seeg" class="form-control">
              <option value="">全部</option>
              <option value="1" {% if has_seeg == "1" %}selected{% endif %}>有</option>
              <option value="0" {% if has_seeg == "0" %}selected{% endif %}>无</option>
            </select>
          </div>
        </div>

        <div class="mt-3 text-end">
          <a href="{% url 'epilepsy:patient_list' %}" class="btn btn-outline-secondary me-2">
            重置全部条件
          </a>
          <button class="btn btn-primary" type="submit">应用高级筛选</button>
        </div>

      </div>
    </div>
  </form>
  <div class="justify-content-end align-items-start mb-2 d-none"
     id="batch-actions">

      <button type="button" class="btn btn-sm btn-primary me-2" id="btn-batch-download-info">
          批量下载信息
      </button>
      <button type="button" class="btn btn-sm btn-danger me-2" id="btn-batch-delete">
          批量删除
      </button>
      <button type="button" class="btn btn-sm btn-secondary me-2" id="btn-batch-clear">
          取消选择
      </button>

      <!-- 批量下载文件：变成小按钮风格 -->
      <div class="card mb-0 ms-2" style="border:none; background:transparent;">
          <button type="button"
                  class="btn btn-sm btn-outline-secondary d-flex align-items-center"
                  id="batch-file-download-toggle"
                  style="cursor: pointer;">
              <span>批量下载文件</span>
              <span id="batch-file-download-icon" class="ms-1">▶</span>
          </button>

          <div class="card-body p-2 mt-1 border rounded" id="batch-file-download-panel" style="display: none;">
              <div class="mb-2">
                  <div class="form-check form-check-inline">
                      <input class="form-check-input batch-modality"
                             type="checkbox"
                             id="modality-pet"
                             value="PET">
                      <label class="form-check-label" for="modality-pet">PET</label>
                  </div>
                  <div class="form-check form-check-inline">
                      <input class="form-check-input batch-modality"
                             type="checkbox"
                             id="modality-mri"
                             value="MRI">
                      <label class="form-check-label" for="modality-mri">MRI</label>
                  </div>
                  <div class="form-check form-check-inline">
                      <input class="form-check-input batch-modality"
                             type="checkbox"
                             id="modality-eeg"
                             value="EEG">
                      <label class="form-check-label" for="modality-eeg">EEG</label>
                  </div>
                  <div class="form-check form-check-inline">
                      <input class="form-check-input batch-modality"
                             type="checkbox"
                             id="modality-seeg"
                             value="sEEG">
                      <label class="form-check-label" for="modality-seeg">sEEG</label>
                  </div>
              </div>

              <button type="button"
                      class="btn btn-sm btn-primary"
                      id="btn-batch-download-files"
                      disabled>
                  确认下载
              </button>
              <small class="text-muted ms-2">
                  将对当前选择的患者打包下载，文件路径为“病历号-患者姓名/模态/文件名”
              </small>
          </div>
      </div>
  </div>
  <table class="table table-striped table-hover align-middle">
    <thead>
      <tr>
        <th class="selection-cell">
          <input type="checkbox" id="select-all-patients">
        </th>
        <th>患者姓名</th>
        <th>性别</th>
        <th>生日</th>
        <th>床号</th>
        <th>入院时间</th>
        <th>操作</th>
        <th>下载</th>
      </tr>
    </thead>
<tbody>
  {% for p in patients %}
  <tr class="patient-row" onclick="openViewPanel({{ p.id }})">
    <td class="selection-cell">
        <input type="checkbox"
               class="patient-select"
               data-patient-id="{{ p.id }}">
    </td>
    <td>{{ p.name }}</td>
    <td>{{ p.get_gender_display }}</td>
    <td>{{ p.birthday }}</td>
    <td>{{ p.bed_number }}</td>
    <td>{{ p.admission_date }}</td>
    <td>
      {% if user.is_authenticated %}
        {% if user.profile.role == 'ADMIN' or user.profile.role == 'STAFF' %}
          <button class="btn btn-sm btn-outline-primary"
                  onclick="event.stopPropagation(); openEditPanel({{ p.id }});">
            修改
          </button>
          <form method="post"
                action="{% url 'epilepsy:patient_delete' p.id %}"
                style="display:inline;">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger"
                    onclick="event.stopPropagation(); return confirm('确认删除该患者？');">
              删除
            </button>
          </form>
        {% endif %}
      {% else %}
        <span class="text-muted">只读</span>
      {% endif %}
    </td>
    <td>
      {# 如果有任意 MRI / PET / EEG / SEEG 文件，则显示“下载管理”按钮 #}
      {% if p.mri_files.exists or p.pet_files.exists or p.eeg_files.exists or p.seeg_files.exists %}
        <button class="btn btn-sm btn-outline-success"
                onclick="event.stopPropagation(); openDownloadPanel({{ p.id }});">
          下载管理
        </button>
      {% elif p.datasets.all %}
        {# 否则如果还有旧的数据集接口，保留原来的“下载数据”入口 #}
        <a href="{% url 'epilepsy:patient_datasets' p.id %}"
           class="btn btn-sm btn-outline-secondary"
           onclick="event.stopPropagation();">
          下载数据
        </a>
      {% else %}
        <span class="text-muted">暂无数据</span>
      {% endif %}
    </td>

  </tr>
  {% empty %}
  <tr>
    <td colspan="6" class="text-center text-muted">暂无患者</td>
  </tr>
  {% endfor %}
</tbody>

  </table>

  <!-- 分页 -->
  {% if patients.paginator.num_pages > 1 %}
  <nav aria-label="患者分页">
    <ul class="pagination">
      {% if patients.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">
          上一页
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">上一页</span>
      </li>
      {% endif %}

      {% for num in patients.paginator.page_range %}
        {% if num == patients.number %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > patients.number|add:"-3" and num < patients.number|add:"3" %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if patients.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ patients.next_page_number }}{% if q %}&q={{ q }}{% endif %}">
          下一页
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">下一页</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- 左侧滑出编辑面板（自定义 drawer，不依赖 Bootstrap Offcanvas） -->
<style>
    /* If you use .table-hover on your table */
    .table-hover tbody tr:hover td.selection-cell {
        background-color: inherit;  /* or #fff if your normal background is white */
    }

    /* Avoid pointer cursor on the checkbox cell */
    td.selection-cell,
    td.selection-cell * {
        cursor: default !important;
    }
  /* 行悬停时略微浮起 */
  .patient-row {
    transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
    cursor: pointer;
  }
  .patient-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,.06);
    background-color: #f8f9fe;
  }
  .patient-row:hover td.selection-cell {
      background-color: inherit;  /* or #fff */
  }
  /* 背景遮罩 */
  #editPatientBackdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, .5);
    opacity: 0;
    visibility: hidden;
    transition: opacity .3s ease;
    z-index: 1040;
  }
  #editPatientBackdrop.show {
    opacity: 1;
    visibility: visible;
  }

  /* 右侧滑出的抽屉（编辑 + 查看共用） */
  #editPatientDrawer {
    position: fixed;
    top: 0;
    right: 0;              /* 右侧 */
    height: 100%;
    width: 70%;
    max-width: 900px;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,.3);
    transform: translateX(100%);    /* 初始藏在右边 */
    transition: transform .3s ease;
    z-index: 1050;
    display: flex;
    flex-direction: column;
  }
  #editPatientDrawer.show {
    transform: translateX(0);       /* 显示时滑入 */
  }

  #editPatientDrawer .drawer-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
  }
  #editPatientDrawer .drawer-body {
    padding: 1rem 1.5rem;
    overflow-y: auto;
  }
</style>

<style>
  /* 高级搜索按钮的小三角形指示 */
  .advanced-toggle::after {
    content: "▸";           /* 小三角 */
    display: inline-block;
    margin-left: .25rem;
    transition: transform 0.2s;
  }

  /* 折叠展开时旋转 */
  .advanced-toggle[aria-expanded="true"]::after {
    transform: rotate(90deg);
  }
</style>

<div id="editPatientBackdrop"></div>

<div id="editPatientDrawer">
  <div class="drawer-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0" id="editPatientDrawerTitle">修改患者</h5>
    <button type="button" class="close" aria-label="关闭" onclick="closeEditPanel()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="drawer-body" id="editPatientBody">
    <div class="text-center text-muted">请选择要查看的患者</div>
  </div>
</div>


<script>
  function showDrawer() {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    drawer.classList.add('show');
    backdrop.classList.add('show');
  }

  function closeEditPanel() {
    const drawer = document.getElementById('editPatientDrawer');
    const backdrop = document.getElementById('editPatientBackdrop');
    drawer.classList.remove('show');
    backdrop.classList.remove('show');
  }

  // 点击遮罩关闭
  document.getElementById('editPatientBackdrop')
          .addEventListener('click', closeEditPanel);

  // ================== 只读详情（不改） ==================
  function openViewPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '患者详情';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/detail/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;   // 只读模板
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }

  // ================== 初始化“添加文件 / 删除”UI ==================
  function initLargeFileUploadUI(form) {
    if (!form) return;

    // 检查当前 form 中是否有待上传文件
    form._hasFilesToUpload = function() {
      var names = ['mri_files', 'pet_files', 'eeg_files', 'seeg_files'];
      for (var i = 0; i < names.length; i++) {
        var input = form.querySelector('input[name="' + names[i] + '"]');
        if (input && input.files && input.files.length > 0) {
          return true;
        }
      }
      return false;
    };

    // “添加文件”按钮 -> 触发隐藏的 <input type="file">
    form.querySelectorAll('.js-add-file-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var sel = btn.getAttribute('data-input-selector');
        var input = form.querySelector(sel);
        if (input) {
          input.click();
        }
      });
    });

    // 某一类文件 input 变更时，在对应表格添加“待上传”行
    function bindFileInput(fieldType) {
      var inputName = fieldType + '_files';
      var input = form.querySelector('input[name="' + inputName + '"]');
      var tbody = form.querySelector('tbody[data-file-type="' + fieldType + '"]');
      if (!input || !tbody) return;

      input.addEventListener('change', function() {
        var files = Array.from(input.files || []);
        if (!files.length) return;

        var emptyRow = tbody.querySelector('.js-empty-row');
        if (emptyRow) {
          emptyRow.parentNode.removeChild(emptyRow);
        }

        files.forEach(function(f) {
          var tr = document.createElement('tr');
          tr.setAttribute('data-new-file', '1');
          tr.innerHTML =
            '<td>' + f.name + '</td>' +
            '<td>待上传</td>' +
            '<td>—</td>' +
            '<td><button type="button" class="btn btn-sm btn-outline-danger js-row-remove">删除</button></td>';
          tbody.appendChild(tr);
        });
      });
    }

    ['mri', 'pet', 'eeg', 'seeg'].forEach(bindFileInput);

    // 删除按钮：已有记录 -> 记录到 delete_xxx_file_ids；新添加的 -> 直接从表格删
    form.addEventListener('click', function(evt) {
      var target = evt.target;
      if (!target.classList.contains('js-row-remove')) return;

      var tr = target.closest('tr');
      if (!tr) return;

      var fileId = tr.getAttribute('data-file-id');
      var tbody = tr.closest('tbody');
      var type = tbody ? tbody.getAttribute('data-file-type') : null;

      if (fileId && type) {
        var hiddenName = 'delete_' + type + '_file_ids';
        var hidden = form.querySelector('input[name="' + hiddenName + '"]');
        if (hidden) {
          var current = hidden.value ? hidden.value.split(',') : [];
          if (current.indexOf(fileId) === -1) {
            current.push(fileId);
          }
          hidden.value = current.join(',');
        }
      }

      tr.parentNode.removeChild(tr);
    });
  }

  // ================== 编辑抽屉：载入可编辑表单 ==================
  function openEditPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '修改患者';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/edit/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;       // 载入 patient_form_partial.html
        attachEditFormHandler(url);  // 绑定保存 + 大文件上传
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }
  
  // ================== 下载管理抽屉：显示各类大文件列表 ==================
  function openDownloadPanel(patientId) {
    const body = document.getElementById('editPatientBody');
    const titleEl = document.getElementById('editPatientDrawerTitle');

    titleEl.textContent = '下载管理';
    showDrawer();

    body.innerHTML = '<div class="text-center text-muted">加载中...</div>';

    const url = `/epilepsy/patients/${patientId}/files/`;

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(resp => resp.text())
      .then(html => {
        body.innerHTML = html;   // 只读文件列表
      })
      .catch(err => {
        console.error(err);
        body.innerHTML = '<div class="alert alert-danger">加载失败</div>';
      });
  }

  // ================== 编辑表单的 AJAX + 上传进度条 ==================

  // ================== 编辑表单的 AJAX + 上传进度条 ==================
  function attachEditFormHandler(url) {
    const body = document.getElementById('editPatientBody');
    const form = body.querySelector('form');
    if (!form) return;

    // 初始化 “添加文件/删除” 相关 UI
    initLargeFileUploadUI(form);

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      var hasFiles = form._hasFilesToUpload ? form._hasFilesToUpload() : false;
      var modalEl = document.getElementById('uploadProgressModal');
      var progressBar = document.getElementById('uploadProgressBar');

      // 有待上传文件 -> 弹出阻塞窗口（依赖 Bootstrap + jQuery）
      if (hasFiles && modalEl && typeof $ !== 'undefined' && $.fn.modal) {
        $(modalEl).modal('show');
        if (progressBar) {
          progressBar.style.width = '0%';
          progressBar.textContent = '0%';
        }
      }

      var xhr = new XMLHttpRequest();
      xhr.open('POST', url);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

      // CSRF
      var csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
      var csrfToken = csrfInput ? csrfInput.value : '';
      if (csrfToken) {
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
      }

      // 上传进度
      xhr.upload.addEventListener('progress', function (ev) {
        if (!hasFiles || !ev.lengthComputable || !progressBar) return;
        var percent = Math.round((ev.loaded / ev.total) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
      });

      xhr.onreadystatechange = function () {
        if (xhr.readyState !== 4) return;

        if (hasFiles && modalEl && typeof $ !== 'undefined' && $.fn.modal) {
          $(modalEl).modal('hide');
        }

        if (xhr.status >= 200 && xhr.status < 300) {
          var contentType = xhr.getResponseHeader('content-type') || '';
          // ✅ 成功：后端返回 JSON {"success": true}
          if (contentType.indexOf('application/json') !== -1) {
            var data = {};
            try {
              data = JSON.parse(xhr.responseText || '{}');
            } catch (e) {
              data = {};
            }
            if (data.success) {
              window.alert('保存成功');
              // 这里可以根据需要选择是否刷新列表页面
              // window.location.reload();
              closeEditPanel();
            } else {
              window.alert('保存失败，请检查表单。');
            }
          }
          // ❌ 表单校验失败：后端重新渲染了 patient_form_partial.html
          else {
            body.innerHTML = xhr.responseText;
            // 重新绑定（包括“添加文件”按钮）
            attachEditFormHandler(url);
          }
        } else {
          window.alert('上传失败，HTTP 状态码: ' + xhr.status);
        }
      };

      var formData = new FormData(form);
      xhr.send(formData);
    }, { once: true });
  }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('select-all-patients');
    const patientCheckboxes = document.querySelectorAll('.patient-select');
    const batchActions = document.getElementById('batch-actions');

    const btnBatchDownloadInfo = document.getElementById('btn-batch-download-info');
    const btnBatchDelete = document.getElementById('btn-batch-delete');
    const btnBatchClear = document.getElementById('btn-batch-clear');

    const downloadInfoForm = document.getElementById('batch-download-info-form');
    const downloadInfoIdsInput = document.getElementById('batch-download-info-ids');

    const deleteForm = document.getElementById('batch-delete-form');
    const deleteIdsInput = document.getElementById('batch-delete-ids');

    const downloadFilesForm = document.getElementById('batch-download-files-form');
    const downloadFilesIdsInput = document.getElementById('batch-download-files-ids');
    const downloadFilesModalitiesInput = document.getElementById('batch-download-files-modalities');

    // 批量下载文件面板
    const batchFileToggle = document.getElementById('batch-file-download-toggle');
    const batchFilePanel = document.getElementById('batch-file-download-panel');
    const batchFileIcon = document.getElementById('batch-file-download-icon');
    const modalityCheckboxes = document.querySelectorAll('.batch-modality');
    const btnBatchDownloadFiles = document.getElementById('btn-batch-download-files');

    function getSelectedPatientIds() {
        return Array.from(patientCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.dataset.patientId);
    }

    function getSelectedModalities() {
        return Array.from(modalityCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
    }

    function updateBatchActionsVisibility() {
        const selectedIds = getSelectedPatientIds();
        if (selectedIds.length > 0) {
            batchActions.style.display = 'flex';
        } else {
            batchActions.style.display = 'none';
        }
        updateDownloadFilesButton();
    }

    function updateDownloadFilesButton() {
        const hasPatients = getSelectedPatientIds().length > 0;
        const hasModalities = getSelectedModalities().length > 0;
        // 只有同时选中患者和文件类型才允许下载
        btnBatchDownloadFiles.disabled = !(hasPatients && hasModalities);
    }

    // 全选
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function () {
            const checked = this.checked;
            patientCheckboxes.forEach(cb => {
                cb.checked = checked;
            });
            updateBatchActionsVisibility();
        });
    }

    // 单行选择
    patientCheckboxes.forEach(cb => {
        cb.addEventListener('change', function () {
            // 如果有任一未选中，取消“全选”
            if (!this.checked && selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            updateBatchActionsVisibility();
        });
    });

    // 取消选择
    btnBatchClear.addEventListener('click', function () {
        patientCheckboxes.forEach(cb => { cb.checked = false; });
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
        }
        updateBatchActionsVisibility();
    });

    // 批量下载信息（CSV）
    btnBatchDownloadInfo.addEventListener('click', function () {
        const ids = getSelectedPatientIds();
        if (ids.length === 0) {
            alert('请先选择至少一位患者。');
            return;
        }
        downloadInfoIdsInput.value = ids.join(',');
        downloadInfoForm.submit();
    });

    // 批量删除（确认提示）
    btnBatchDelete.addEventListener('click', function () {
        const ids = getSelectedPatientIds();
        if (ids.length === 0) {
            alert('请先选择至少一位患者。');
            return;
        }
        if (!confirm('确认要删除所选患者吗？该操作不可撤销。')) {
            return;
        }
        deleteIdsInput.value = ids.join(',');
        deleteForm.submit();
    });

    // 批量下载文件面板展开/收起
    batchFileToggle.addEventListener('click', function () {
        const isHidden = batchFilePanel.style.display === 'none';
        batchFilePanel.style.display = isHidden ? 'block' : 'none';
        batchFileIcon.textContent = isHidden ? '▼' : '▶';
    });

    // 选择文件类型时更新按钮状态
    modalityCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateDownloadFilesButton);
    });

    // 批量下载文件（打包 ZIP）
    btnBatchDownloadFiles.addEventListener('click', function () {
        const ids = getSelectedPatientIds();
        const modalities = getSelectedModalities();
        if (ids.length === 0) {
            alert('请先在列表中选择至少一位患者。');
            return;
        }
        if (modalities.length === 0) {
            alert('请至少选择一种文件类型（PET/MRI/EEG/sEEG）。');
            return;
        }
        downloadFilesIdsInput.value = ids.join(',');
        downloadFilesModalitiesInput.value = modalities.join(',');
        downloadFilesForm.submit();
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const batchActions = document.getElementById('batch-actions');
    const patientCheckboxes = document.querySelectorAll('.patient-select');
    const selectAllCheckbox = document.getElementById('select-all-patients');  // if you have it

    function anyPatientSelected() {
        return Array.from(patientCheckboxes).some(cb => cb.checked);
    }

    function updateBatchActionsVisibility() {
        if (anyPatientSelected()) {
            batchActions.classList.remove('d-none');
            batchActions.classList.add('d-flex');
        } else {
            batchActions.classList.add('d-none');
            batchActions.classList.remove('d-flex');
        }
    }

    // 单个患者复选框
    patientCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateBatchActionsVisibility);
    });

    // 全选复选框
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function () {
            const checked = this.checked;
            patientCheckboxes.forEach(cb => { cb.checked = checked; });
            updateBatchActionsVisibility();
        });
    }

    // 初始状态（根据是否有预先选中的患者）
    updateBatchActionsVisibility();
});

  // 行点击：打开详情（或编辑）抽屉
  document.querySelectorAll('.patient-row').forEach(function (row) {
    row.addEventListener('click', function (e) {
      // 如果点击来自选择框所在单元格，直接返回，不打开抽屉
      if (e.target.closest('.selection-cell') || e.target.classList.contains('patient-select')) {
        return;
      }

      const patientId = this.dataset.patientId;
      // 根据需要调用你的函数：openViewPanel / openEditPanel / openDownloadPanel
      openViewPanel(patientId);  // 举例
    });
  });

  // 显式阻止复选框点击冒泡（双保险）
  document.querySelectorAll('.patient-select').forEach(function (cb) {
    cb.addEventListener('click', function (e) {
      e.stopPropagation();  // 不让事件冒泡到 tr 的点击监听器
    });
  });
</script>


<form id="batch-download-info-form"
      method="post"
      action="{% url 'epilepsy:batch_download_info' %}"
      style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="patient_ids" id="batch-download-info-ids">
</form>

<form id="batch-delete-form"
      method="post"
      action="{% url 'epilepsy:batch_delete_patients' %}"
      style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="patient_ids" id="batch-delete-ids">
</form>

<form id="batch-download-files-form"
      method="post"
      action="{% url 'epilepsy:batch_download_files' %}"
      style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="patient_ids" id="batch-download-files-ids">
    <input type="hidden" name="modalities" id="batch-download-files-modalities">
</form>

<!-- Image Preview Overlay (Lightbox) -->
<div id="imgPreviewOverlay" class="img-preview-overlay" aria-hidden="true">
  <div class="img-preview-dialog" role="dialog" aria-modal="true" aria-label="Image preview">
    <button id="imgPreviewOverlayClose"
            class="img-preview-close"
            type="button"
            aria-label="Close">×</button>
    <img id="imgPreviewOverlayImg" src="" alt="">
  </div>
</div>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'assets/js/image_preview_lightbox.js' %}"></script>
{% endblock %}
