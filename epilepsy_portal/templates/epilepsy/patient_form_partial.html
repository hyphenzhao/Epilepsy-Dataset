{% load static %}
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div id="patientAccordion">

    <!-- 一、基本信息（默认展开） -->
    <div class="card mb-3">
      <div class="card-header" id="headingBasic">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left" type="button"
                  data-toggle="collapse" data-target="#collapseBasic"
                  aria-expanded="true" aria-controls="collapseBasic">
            一、基本信息
          </button>
        </h5>
      </div>

      <div id="collapseBasic" class="collapse show"
           aria-labelledby="headingBasic" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              {{ form.name.label_tag }} 
              {{ form.name }}
              {{ form.name.errors }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.gender.label_tag }}
              {{ form.gender }}
              {{ form.gender.errors }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.handedness.label_tag }}
              {{ form.handedness }}
              {{ form.handedness.errors }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.birthday.label_tag }}
              {{ form.birthday }}
              {{ form.birthday.errors }}
            </div>
          </div>

          <div class="row">
            <div class="col-md-3 mb-3">
              {{ form.department.label_tag }}
              {{ form.department }}
              {{ form.department.errors }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.bed_number.label_tag }}
              {{ form.bed_number }}
              {{ form.bed_number.errors }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.medical_record_number.label_tag }}
              {{ form.medical_record_number }}
              {{ form.medical_record_number.errors }}
            </div>

            <div class="col-md-3 mb-3">
              {{ form.admission_date.label_tag }}
              {{ form.admission_date }}
              {{ form.admission_date.errors }}
            </div>
          </div>

          <div class="row">
            <div class="col-md-3 mb-3">
              {{ form.education_level.label_tag }}
              {{ form.education_level }}
              {{ form.education_level.errors }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.occupation.label_tag }}
              {{ form.occupation }}
              {{ form.occupation.errors }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.imaging_number.label_tag }}
              {{ form.imaging_number }}
              {{ form.imaging_number.errors }}
            </div>

            <div class="col-md-3 mb-3">
              {{ form.admission_diagnosis.label_tag }}
              {{ form.admission_diagnosis }}
              {{ form.admission_diagnosis.errors }}
            </div>
          </div>
      </div>
     </div>
    </div>

    <!-- 二、病史 -->
    <div class="card mb-3">
      <div class="card-header" id="headingHistory">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseHistory"
                  aria-expanded="false" aria-controls="collapseHistory">
            二、病史
          </button>
        </h5>
      </div>
      <div id="collapseHistory" class="collapse"
           aria-labelledby="headingHistory" data-parent="#patientAccordion">
        <div class="card-body">
          <!-- <div class="mb-3">
            {{ form.pregnancy_birth_history.label_tag }}
            {{ form.pregnancy_birth_history }}
            {{ form.pregnancy_birth_history.errors }}
          </div> -->

          <!-- <div class="row">
            <div class="col-md-4 mb-3">
              {{ form.education_level.label_tag }}
              {{ form.education_level }}
              {{ form.education_level.errors }} 
            </div>
            <div class="col-md-8 mb-3">
              {{ form.occupation.label_tag }}
              {{ form.occupation }}
              {{ form.occupation.errors }}
            </div> 
          </div> -->

          <div class="row">
            <div class="col-md-4 mb-3">
              {{ form.first_seizure_age.label_tag }}
              {{ form.first_seizure_age }}
              {{ form.first_seizure_age.errors }}
            </div>
            <div class="col-md-2 mb-3">
              {{ form.first_seizure_description.label_tag }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.first_seizure_description }}
            </div>
              
              {{ form.first_seizure_description.errors }}
          </div>

          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.past_medical_history.label_tag }}
            </div>
            <div>
              {{ form.past_medical_history }}
            </div>
              {{ form.past_medical_history.errors }}
              <div class="row mb-3" id="wrap_pmh_other_text" style="display:none;">
            <div class="col-md-2"></div>
            <div class="col-md-6">
              {{ form.past_medical_history_other_text }}
              {{ form.past_medical_history_other_text.errors }}
            </div>
          </div>
            
          </div>

            
          
          
          <div class="row mb-3">
            <!-- <div class="col-md-2 d-flex align-items-center">
                {{ form.other_medical_history.label_tag }}
            </div>
            <div class="col-md-4">
                {{ form.other_medical_history }}
                {{ form.other_medical_history.errors }}
            </div> -->

            <div class="col-md-2 d-flex align-items-center">
                {{ form.family_history.label_tag }}
            </div>
            <div class="col-md-4">
                {{ form.family_history }}
                {{ form.family_history.errors }}
            </div>
          </div>

          <div class="mb-3">
            {{ form.medication_history.label_tag }}
            {{ form.medication_history }}
            {{ form.medication_history.errors }}
          </div>
        </div>
      </div>
    </div>

    <!-- 三、发作症状学 -->
    <div class="card mb-3">
      <div class="card-header" id="headingSemiology">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseSemiology"
                  aria-expanded="false" aria-controls="collapseSemiology">
            三、发作症状学
          </button>
        </h5>
      </div>
      <div id="collapseSemiology" class="collapse"
           aria-labelledby="headingSemiology" data-parent="#patientAccordion">
        <div class="card-body">
<div class="row align-items-center mb-3">
  <div class="col-md-2">
    {{ form.seizure_state.label_tag }}
  </div>
  <div class="col-md-4">
    {{ form.seizure_state }}
    {{ form.seizure_state.errors }}
  </div>
</div>

<div class="row align-items-center mb-3">
  <div class="col-md-2">
    {{ form.aura.label_tag }}
  </div>
  <div class="col-md-8 d-flex gap-3">
    <div style="width:140px">
      {{ form.aura }}
      {{ form.aura.errors }}
    </div>
    <div id="wrap_aura_text" style="display:none; flex:1;">
      {{ form.aura_text }}
      {{ form.aura_text.errors }}
    </div>
  </div>
</div>
          <!-- <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.aura.label_tag }}
              {{ form.aura }}
              {{ form.aura.errors }}
            </div>
            <div class="col-md-4 mb-3">
              {{ form.typical_seizure_time.label_tag }}
              {{ form.typical_seizure_time }}
              {{ form.typical_seizure_time.errors }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.typical_seizure_semiology.label_tag }}
              {{ form.typical_seizure_semiology }}
              {{ form.typical_seizure_semiology.errors }}
            </div>
          </div> -->
          <div class="mb-3">
            {{ form.initial_seizure_symptom.label_tag }}
            {{ form.initial_seizure_symptom }}
            {{ form.initial_seizure_symptom.errors }}
          </div>
          <div class="mb-3">
            {{ form.evolution_symptom.label_tag }}
            {{ form.evolution_symptom }}
            {{ form.evolution_symptom.errors }}
          </div>
                    <div class="mb-3">
            {{ form.postictal_state.label_tag }}
            {{ form.postictal_state }}
            {{ form.postictal_state.errors }}
          </div>

          <div class="row">
            <div class="col-md-3 mb-3">
              {{ form.seizure_duration_seconds.label_tag }}
              {{ form.seizure_duration_seconds }}
              {{ form.seizure_duration_seconds.errors }}
            </div>
            <!-- <div class="col-md-3 mb-3">
              {{ form.seizure_duration_minutes.label_tag }}
              {{ form.seizure_duration_minutes }}
              {{ form.seizure_duration_minutes.errors }}
            </div> -->
            <div class="col-md-3 mb-3">
              {{ form.seizure_freq_per_day.label_tag }}
              {{ form.seizure_freq_per_day }}
              {{ form.seizure_freq_per_day.errors }}
            </div>
            <!-- <div class="col-md-3 mb-3">
              {{ form.seizure_freq_per_week.label_tag }}
              {{ form.seizure_freq_per_week }}
              {{ form.seizure_freq_per_week.errors }}
            </div> -->
          </div>

          <!-- <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.seizure_freq_per_month.label_tag }}
              {{ form.seizure_freq_per_month }}
              {{ form.seizure_freq_per_month.errors }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.seizure_freq_per_year.label_tag }}
              {{ form.seizure_freq_per_year }}
              {{ form.seizure_freq_per_year.errors }}
            </div>
          </div> -->
        </div>
      </div>
    </div>

    <!-- 四、神经系统检查 -->
    <div class="card mb-3">
      <div class="card-header" id="headingNeuro">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseNeuro"
                  aria-expanded="false" aria-controls="collapseNeuro">
            四、神经系统检查
          </button>
        </h5>
      </div>
      <div id="collapseNeuro" class="collapse"
           aria-labelledby="headingNeuro" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              {{ form.neuro_exam.label_tag }}
              {{ form.neuro_exam }}
              {{ form.neuro_exam.errors }}
            </div>

            <div class="col-md-9 mb-3" id="wrap_neuro_exam_desc" style="display:none;">
              {{ form.neuro_exam_description.label_tag }}
              {{ form.neuro_exam_description }}
              {{ form.neuro_exam_description.errors }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 五、认知和精神量表 -->
    <div class="card mb-3">
      <div class="card-header" id="headingCognitive">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseCognitive"
                  aria-expanded="false" aria-controls="collapseCognitive">
            五、认知和精神量表
          </button>
        </h5>
      </div>
      <div id="collapseCognitive" class="collapse"
           aria-labelledby="headingCognitive" data-parent="#patientAccordion">
        <div class="card-body">
            {{ form.assessment_done }}
          <div id="wrap_assessment_scores" style="display:none;">
            <div class="row">
              <div class="col-md-2 mb-3">
                {{ form.moca_score.label_tag }}
                {{ form.moca_score }}
                {{ form.moca_score.errors }}
              </div>
              <div class="col-md-2 mb-3">
                {{ form.hama_score.label_tag }}
                {{ form.hama_score }}
                {{ form.hama_score.errors }}
              </div>
              <div class="col-md-2 mb-3">
                {{ form.hamd_score.label_tag }}
                {{ form.hamd_score }}
                {{ form.hamd_score.errors }}
              </div>
              <div class="col-md-2 mb-3">
                {{ form.bai_score.label_tag }}
                {{ form.bai_score }}
                {{ form.bai_score.errors }}
              </div>
              <div class="col-md-2 mb-3">
                {{ form.bdi_score.label_tag }}
                {{ form.bdi_score }}
                {{ form.bdi_score.errors }}
              </div>
              <div class="col-md-2 mb-3">
                {{ form.epilepsy_scale_score.label_tag }}
                {{ form.epilepsy_scale_score }}
                {{ form.epilepsy_scale_score.errors }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 六、视频头皮 EEG 检查 -->
    <div class="card mb-3">
      <div class="card-header" id="headingEEG">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseEEG"
                  aria-expanded="false" aria-controls="collapseEEG">
            六、视频头皮 EEG 检查
          </button>
        </h5>
      </div>
      <div id="collapseEEG" class="collapse"
           aria-labelledby="headingEEG" data-parent="#patientAccordion">
        <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-3">
          {{ form.eeg_recording_electrodes.label_tag }}
          {{ form.eeg_recording_electrodes }}
          {{ form.eeg_recording_electrodes.errors }}
          </div>

          <div class="col-md-4 mb-3">
            {{ form.eeg_recording_duration_days.label_tag }}
            {{ form.eeg_recording_duration_days }}
            {{ form.eeg_recording_duration_days.errors }}
          </div>

          <div class="col-md-5 mb-3">
            {{ form.eeg_bg_occipital_rhythm.label_tag }}
            {{ form.eeg_bg_occipital_rhythm }}
            {{ form.eeg_bg_occipital_rhythm.errors }}
          </div>
        </div>
          <div class="row">
          <div class="col-md-4 mb-3">
            {{ form.eeg_eye_response.label_tag }}
            {{ form.eeg_eye_response }}
            {{ form.eeg_eye_response.errors }}
          </div>

          <div class="col-md-4 mb-3">
            {{ form.eeg_symmetry.label_tag }}
            {{ form.eeg_symmetry }}
            {{ form.eeg_symmetry.errors }}
          </div>

          <div class="col-md-4 mb-3">
            {{ form.eeg_awake_background.label_tag }}
            {{ form.eeg_awake_background }}
            {{ form.eeg_awake_background.errors }}
          </div>
        </div>

          <div class="d-flex align-items-center mt-3 mb-2">
            <strong class="d-block mt-3 mb-2">● HV 过度换气诱发：</strong>
            <div>
              {{ form.eeg_hv_result }}
              {{ form.eeg_hv_result.errors }}
            </div>
          </div>

          <div id="wrap_hv_related_change" style="display:none;">
            <div class="row mt-2">
              <div class="col-md-4 mb-3">
                {{ form.eeg_hv_slow_wave_build.label_tag }}
                {{ form.eeg_hv_slow_wave_build }}
                {{ form.eeg_hv_slow_wave_build.errors }}
              </div>

              <div class="col-md-4 mb-3">
                {{ form.eeg_hv_slow_wave_frequency.label_tag }}
                {{ form.eeg_hv_slow_wave_frequency }}
                {{ form.eeg_hv_slow_wave_frequency.errors }}
              </div>

              <div class="col-md-4 mb-3">
                {{ form.eeg_hv_slow_wave_symmetry.label_tag }}
                {{ form.eeg_hv_slow_wave_symmetry }}
                {{ form.eeg_hv_slow_wave_symmetry.errors }}
              </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.eeg_hv_epileptiform_discharge.label_tag }}
              {{ form.eeg_hv_epileptiform_discharge }}
              {{ form.eeg_hv_epileptiform_discharge.errors }}
            </div>

            <div class="col-md-6 mb-3">
              {{ form.eeg_hv_discharge_laterality.label_tag }}
              {{ form.eeg_hv_discharge_laterality }}
              {{ form.eeg_hv_discharge_laterality.errors }}
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center mt-3 mb-2">
            <strong class="d-block mt-3 mb-2">● IPS 闪光刺激诱发：</strong>
            <div>
              {{ form.ips_result }}
              {{ form.ips_result.errors }}
            </div>
        </div>
        <div id="wrap_ips_related_change" style="display:none;">
          <div class="row mb-3">
            <div class="col-md-4">
              <label><strong>光驱动：</strong></label>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              {{ form.frequency.label_tag }}
              {{ form.frequency }}
              {{ form.frequency.error }}
            </div>

            <div class="col-md-4">
              {{ form.laterality.label_tag }}
              {{ form.laterality }}
              {{ form.laterality.error }}
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label><strong>PPR 光阵发性反应：</strong></label>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              {{ form.frequency.label_tag }}
              {{ form.frequency }}
              {{ form.frequency.error }}
            </div>

            <div class="col-md-4">
              {{ form.laterality.label_tag }}
              {{ form.laterality }}
              {{ form.laterality.error }}
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label><strong>PCR 光惊厥反应：</strong></label>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              {{ form.frequency.label_tag }}
              {{ form.frequency }}
              {{ form.frequency.error }}
            </div>
          </div>
        </div>

        <div class="mt-3 mb-2 d-flex align-items-center">
          <strong class="me-3">● 睡眠周期：</strong>
          <div style="width: 200px;">
              {{ form.eeg_sleep_period_overall }}
          </div>
        </div>

        <div class="row mb-2">

            <div class="col-md-4">
                {{ form.eeg_sleep_vertex_wave.label_tag }}
                {{ form.eeg_sleep_vertex_wave }}
                {{ form.eeg_sleep_vertex_wave.error }}
            </div>

            <div class="col-md-4">
                {{ form.eeg_sleep_k_complex.label_tag }}
                {{ form.eeg_sleep_k_complex }}
                {{ form.eeg_sleep_k_complex.error }}
            </div>

            <div class="col-md-4">
                {{ form.eeg_sleep_spindle.label_tag }}
                {{ form.eeg_sleep_spindle }}
                {{ form.eeg_sleep_spindle.error }}
            </div>
        </div>

        <div class="mt-4 mb-2">
            <strong>● EEG 发作间期癫痫样放电：</strong>
          </div>

          <!-- 状态 -->
          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_interictal_state.label_tag }}
            </div>
            <div>
              {{ form.eeg_interictal_state }}
              {{ form.eeg_interictal_state.errors }}
            </div>
          </div>
          <!-- 部位 -->
          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_interictal_location.label_tag }}
            </div>

            <div class="col-md-10">
              {% for cb in form.eeg_interictal_location %}
                <label class="mr-3">
                  {{ cb.tag }} {{ cb.choice_label }}
                </label>

                {% if cb.data.value == "FOCAL" %}
                  <span id="wrap_eeg_interictal_focal_lobe" style="display:none; margin-left:6px;">
                    {{ form.eeg_interictal_focal_lobe }}
                    {{ form.eeg_interictal_focal_lobe.errors }}
                  </span>
                {% endif %}
              

                {% if cb.data.value == "LAT" %}
                  <span id="wrap_eeg_interictal_laterality"
                        style="display:none; margin-left:6px;">
                    {{ form.eeg_interictal_laterality }}
                    {{ form.eeg_interictal_laterality.errors }}
                  </span>
                {% endif %}
              {% endfor %}

              {{ form.eeg_interictal_location.errors }}
            </div>
          </div>

          <!-- 波幅 / 波形 -->
          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_interictal_morph.label_tag }}
            </div>
            <div>
              {{ form.eeg_interictal_morph }}
              {{ form.eeg_interictal_morph.errors }}
            </div>
          </div>
          <!-- 数量 -->
         <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_interictal_amount.label_tag }}
            </div>
            <div>
              {{ form.eeg_interictal_amount }}
              {{ form.eeg_interictal_amount.errors }}
            </div>
          </div>
          <!-- 出现方式 -->
          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_interictal_pattern.label_tag }}
            </div>
            <div>
              {{ form.eeg_interictal_pattern }}
              {{ form.eeg_interictal_pattern.errors }}
            </div>
          </div>
          <!-- 眼状态相关 -->
          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_interictal_eye_relation.label_tag }}
            </div>
            <div>
              {{ form.eeg_interictal_eye_relation }}
              {{ form.eeg_interictal_eye_relation.errors }}
            </div>
          </div>
          <div class="mt-4 mb-2">
            <strong>● EEG 发作期放电：</strong>
          </div>
          <!-- <div class="mb-3">
            {{ form.eeg_interictal.label_tag }}
            {{ form.eeg_interictal }}
            {{ form.eeg_interictal.errors }}
          </div> -->
          <!-- <div class="mb-3">
            {{ form.eeg_ictal.label_tag }}
            {{ form.eeg_ictal }}
            {{ form.eeg_ictal.errors }}
          </div> -->
          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_ictal_state.label_tag }}
            </div>
            <div>
              {{ form.eeg_ictal_state }}
              {{ form.eeg_ictal_state.errors }}
            </div>
          </div>

          <div class="row">
            <div class="col-md-2 mb-3">
              {{ form.eeg_ictal_location.label_tag }}
            </div>

            <div class="col-md-10">
              {% for cb in form.eeg_ictal_location %}
                <label class="mr-3">
                  {{ cb.tag }} {{ cb.choice_label }}
                </label>

                {% if cb.data.value == "FOCAL" %}
                  <span id="wrap_eeg_ictal_focal_lobe"
                        style="display:none; margin-left:6px;">
                    {{ form.eeg_interictal_focal_lobe }}
                    {{ form.eeg_interictal_focal_lobe.errors }}
                  </span>
                {% endif %}

                {% if cb.data.value == "LAT" %}
                  <span id="wrap_eeg_ictal_laterality"
                        style="display:none; margin-left:6px;">
                    {{ form.eeg_interictal_laterality }}
                    {{ form.eeg_interictal_laterality.errors }}
                  </span>
                {% endif %}
              {% endfor %}

              {{ form.eeg_ictal_location.errors }}
            </div>
          </div>

          <div class="mb-3">
            {{ form.eeg_ictal.label_tag }}
            {{ form.eeg_ictal }}
            {{ form.eeg_ictal.errors }}
          </div>

          <div class="mb-3">
            {{ form.eeg_relevance.label_tag }}
            {{ form.eeg_relevance }}
            {{ form.eeg_relevance.errors }}
          </div>

          <div class=" mb-3">
              {{ form.eeg_ictal_amount.label_tag }}
              {{ form.eeg_ictal_amount }}
              {{ form.eeg_ictal_amount.errors }}
          </div>

          <div class="mb-3">
            {{ form.eeg_clinical_correlation.label_tag }}
            {{ form.eeg_clinical_correlation }}
            {{ form.eeg_clinical_correlation.errors }}
          </div>
          <!-- <div class="mb-3">
            {{ form.eeg_file_link.label_tag }}
            {{ form.eeg_file_link }}
            {{ form.eeg_file_link.errors }}
          </div> -->

          {# ========= EEG 文件列表区域 ========= #}
          <hr>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">EEG 文件列表</h6>
            <button type="button"
                    class="btn btn-sm btn-outline-success js-add-file-btn"
                    data-input-selector="#id_eeg_files">
              添加文件
            </button>
          </div>

          <input type="file" id="id_eeg_files" name="eeg_files" multiple style="display:none;">
          <input type="hidden" id="id_delete_eeg_file_ids" name="delete_eeg_file_ids" value="">

          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>文件名</th>
                  <th>上传状态</th>
                  <th>SHA256 校验码</th>
                  <th>管理</th>
                </tr>
              </thead>
              <tbody data-file-type="eeg">
                {% with form.instance as p %}
                  {% if p.pk and p.eeg_files.all %}
                    {% for f in p.eeg_files.all %}
                      <tr data-file-id="{{ f.id }}">
                        <td>{{ f.file_name }}</td>
                        <td>已上传</td>
                        <td><code>{{ f.sha256_code }}</code></td>
                        <td>
                          <a href="{% url 'epilepsy:patient_file_download' 'eeg' f.id %}"
                             class="btn btn-sm btn-outline-primary">
                            下载
                          </a>
                          <button type="button"
                                  class="btn btn-sm btn-outline-danger js-row-remove">
                            删除
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr class="js-empty-row">
                      <td colspan="4" class="text-muted">暂无文件</td>
                    </tr>
                  {% endif %}
                {% endwith %}
              </tbody>
            </table>
          </div>
          {# ========= /EEG 文件列表区域 ========= #}
        </div>
      </div>
    </div>


     <!-- 七、影像学检查 -->
    <div class="card mb-3">
      <div class="card-header" id="headingImaging">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseImaging"
                  aria-expanded="false" aria-controls="collapseImaging">
            七、影像学检查
          </button>
        </h5>
      </div>
      <div id="collapseImaging" class="collapse"
           aria-labelledby="headingImaging" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="mb-3">
            {{ form.mri_brief.label_tag }}
            {{ form.mri_brief }}
            {{ form.mri_brief.errors }}
          </div>
          <!-- <div class="mb-3">
            {{ form.mri_link.label_tag }}
            {{ form.mri_link }}
            {{ form.mri_link.errors }}
            {% if form.instance.pk and form.instance.mri_link %}
              <a href="{{ form.instance.mri_link }}" target="_blank"
                 class="btn btn-sm btn-outline-primary mt-2">
                下载 MRI 图像（外部链接）
              </a>
            {% endif %}
          </div> -->

          {# ========= MRI 文件列表 ========= #}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">MRI 文件列表</h6>
            <button type="button"
                    class="btn btn-sm btn-outline-success js-add-file-btn"
                    data-input-selector="#id_mri_files">
              添加文件
            </button>
          </div>

          <input type="file" id="id_mri_files" name="mri_files" multiple style="display:none;">
          <input type="hidden" id="id_delete_mri_file_ids" name="delete_mri_file_ids" value="">

          <div class="table-responsive mb-3">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>文件名</th>
                  <th>上传状态</th>
                  <th>SHA256 校验码</th>
                  <th>管理</th>
                </tr>
              </thead>
              <tbody data-file-type="mri">
                {% with form.instance as p %}
                  {% if p.pk and p.mri_files.all %}
                    {% for f in p.mri_files.all %}
                      <tr data-file-id="{{ f.id }}">
                        <td>{{ f.file_name }}</td>
                        <td>已上传</td>
                        <td><code>{{ f.sha256_code }}</code></td>
                        <td>
                          <a href="{% url 'epilepsy:patient_file_download' 'mri' f.id %}"
                             class="btn btn-sm btn-outline-primary">
                            下载
                          </a>
                          <button type="button"
                                  class="btn btn-sm btn-outline-danger js-row-remove">
                            删除
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr class="js-empty-row">
                      <td colspan="4" class="text-muted">暂无文件</td>
                    </tr>
                  {% endif %}
                {% endwith %}
              </tbody>
            </table>
          </div>
          {# ========= /MRI 文件列表 ========= #}

          <div class="mb-3">
            {{ form.pet_brief.label_tag }}
            {{ form.pet_brief }}
            {{ form.pet_brief.errors }}
          </div>
          <!-- <div class="mb-3">
            {{ form.pet_link.label_tag }}
            {{ form.pet_link }}
            {{ form.pet_link.errors }}
            {% if form.instance.pk and form.instance.pet_link %}
              <a href="{{ form.instance.pet_link }}" target="_blank"
                 class="btn btn-sm btn-outline-primary mt-2">
                下载 PET 图像（外部链接）
              </a>
            {% endif %}
          </div> -->

          {# ========= PET 文件列表 ========= #}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">PET 文件列表</h6>
            <button type="button"
                    class="btn btn-sm btn-outline-success js-add-file-btn"
                    data-input-selector="#id_pet_files">
              添加文件
            </button>
          </div>

          <input type="file" id="id_pet_files" name="pet_files" multiple style="display:none;">
          <input type="hidden" id="id_delete_pet_file_ids" name="delete_pet_file_ids" value="">

          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>文件名</th>
                  <th>上传状态</th>
                  <th>SHA256 校验码</th>
                  <th>管理</th>
                </tr>
              </thead>
              <tbody data-file-type="pet">
                {% with form.instance as p %}
                  {% if p.pk and p.pet_files.all %}
                    {% for f in p.pet_files.all %}
                      <tr data-file-id="{{ f.id }}">
                        <td>{{ f.file_name }}</td>
                        <td>已上传</td>
                        <td><code>{{ f.sha256_code }}</code></td>
                        <td>
                          <a href="{% url 'epilepsy:patient_file_download' 'pet' f.id %}"
                             class="btn btn-sm btn-outline-primary">
                            下载
                          </a>
                          <button type="button"
                                  class="btn btn-sm btn-outline-danger js-row-remove">
                            删除
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr class="js-empty-row">
                      <td colspan="4" class="text-muted">暂无文件</td>
                    </tr>
                  {% endif %}
                {% endwith %}
              </tbody>
            </table>
          </div>
          {# ========= /PET 文件列表 ========= #}
        </div>
      </div>
    </div>


    <!-- 八、一期无创性评估结果 -->
    <div class="card mb-3">
      <div class="card-header" id="headingFirstStage">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseFirstStage"
                  aria-expanded="false" aria-controls="collapseFirstStage">
            八、一期无创性评估结果
          </button>
        </h5>
      </div>
      <div id="collapseFirstStage" class="collapse"
           aria-labelledby="headingFirstStage" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              {{ form.first_stage_lateralization.label_tag }}
              {{ form.first_stage_lateralization }}
              {{ form.first_stage_lateralization.errors }}
            </div>
            <div class="col-md-4 mb-3">
              {{ form.first_stage_region.label_tag }}
              {{ form.first_stage_region }}
              {{ form.first_stage_region.errors }}
            </div>
            <div class="col-md-4 mb-3">
              {{ form.first_stage_location.label_tag }}
              {{ form.first_stage_location }}
              {{ form.first_stage_location.errors }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 九、SEEG 发作间期及发作期放电 -->
    <div class="card mb-3">
      <div class="card-header" id="headingSEEG">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseSEEG"
                  aria-expanded="false" aria-controls="collapseSEEG">
            九、SEEG 发作间期及发作期放电
          </button>
        </h5>
      </div>
      <div id="collapseSEEG" class="collapse"
           aria-labelledby="headingSEEG" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="mb-3">
            {{ form.seeg_interictal_overall.label_tag }}
            {{ form.seeg_interictal_overall }}
            {{ form.seeg_interictal_overall.errors }}
          </div>

          <!-- <div class="row">
            <div class="col-md-4 mb-3">
              {{ form.seeg_group1.label_tag }}
              {{ form.seeg_group1 }}
              {{ form.seeg_group1.errors }}
            </div>
            <div class="col-md-4 mb-3">
              {{ form.seeg_group2.label_tag }}
              {{ form.seeg_group2 }}
              {{ form.seeg_group2.errors }}
            </div>
            <div class="col-md-4 mb-3">
              {{ form.seeg_group3.label_tag }}
              {{ form.seeg_group3 }}
              {{ form.seeg_group3.errors }}
            </div>
          </div> -->

          <div class="mb-3">
            {{ form.seeg_ictal.label_tag }}
            {{ form.seeg_ictal }}
            {{ form.seeg_ictal.errors }}
          </div>
          
          <!-- <div class="mb-3">
            {{ form.seeg_file_link.label_tag }}
            {{ form.seeg_file_link }}
            {{ form.seeg_file_link.errors }}
          </div> -->

          {# ========= SEEG 文件列表 ========= #}
          <hr>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">SEEG 文件列表</h6>
            <button type="button"
                    class="btn btn-sm btn-outline-success js-add-file-btn"
                    data-input-selector="#id_seeg_files">
              添加文件
            </button>
          </div>

          <input type="file" id="id_seeg_files" name="seeg_files" multiple style="display:none;">
          <input type="hidden" id="id_delete_seeg_file_ids" name="delete_seeg_file_ids" value="">

          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>文件名</th>
                  <th>上传状态</th>
                  <th>SHA256 校验码</th>
                  <th>管理</th>
                </tr>
              </thead>
              <tbody data-file-type="seeg">
                {% with form.instance as p %}
                  {% if p.pk and p.seeg_files.all %}
                    {% for f in p.seeg_files.all %}
                      <tr data-file-id="{{ f.id }}">
                        <td>{{ f.file_name }}</td>
                        <td>已上传</td>
                        <td><code>{{ f.sha256_code }}</code></td>
                        <td>
                          <a href="{% url 'epilepsy:patient_file_download' 'seeg' f.id %}"
                             class="btn btn-sm btn-outline-primary">
                            下载
                          </a>
                          <button type="button"
                                  class="btn btn-sm btn-outline-danger js-row-remove">
                            删除
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr class="js-empty-row">
                      <td colspan="4" class="text-muted">暂无文件</td>
                    </tr>
                  {% endif %}
                {% endwith %}
              </tbody>
            </table>
          </div>
          {# ========= /SEEG 文件列表 ========= #}
        </div>
      </div>
    </div>


    <!-- 十、二期有创性评估结果 -->
    <div class="card mb-3">
      <div class="card-header" id="headingSecondStage">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseSecondStage"
                  aria-expanded="false" aria-controls="collapseSecondStage">
            十、二期有创性评估结果
          </button>
        </h5>
      </div>
      <div id="collapseSecondStage" class="collapse"
           aria-labelledby="headingSecondStage" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="mb-3">
            {{ form.second_stage_core_zone.label_tag }}
            {{ form.second_stage_core_zone }}
            {{ form.second_stage_core_zone.errors }}
          </div>
          <div class="mb-3">
            {{ form.second_stage_hypothesis_zone.label_tag }}
            {{ form.second_stage_hypothesis_zone }}
            {{ form.second_stage_hypothesis_zone.errors }}
          </div>
        </div>
      </div>
    </div>

    <!-- 十一、外科切除计划 -->
    <div class="card mb-3">
      <div class="card-header" id="headingResection">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseResection"
                  aria-expanded="false" aria-controls="collapseResection">
            十一、外科切除计划
          </button>
        </h5>
      </div>
      <div id="collapseResection" class="collapse"
           aria-labelledby="headingResection" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="mb-3">
            {{ form.resection_plan_convex.label_tag }}
            {{ form.resection_plan_convex }}
            {{ form.resection_plan_convex.errors }}
          </div>
          <div class="mb-3">
            {{ form.resection_plan_concave.label_tag }}
            {{ form.resection_plan_concave }}
            {{ form.resection_plan_concave.errors }}
          </div>
        </div>
      </div>
    </div>

    <!-- 十二、评估信息 -->
    <div class="card mb-3">
      <div class="card-header" id="headingEvaluation">
        <h5 class="mb-0">
          <button class="btn btn-link btn-block text-left collapsed" type="button"
                  data-toggle="collapse" data-target="#collapseEvaluation"
                  aria-expanded="false" aria-controls="collapseEvaluation">
            十二、评估信息
          </button>
        </h5>
      </div>
      <div id="collapseEvaluation" class="collapse"
           aria-labelledby="headingEvaluation" data-parent="#patientAccordion">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.evaluator.label_tag }}
              {{ form.evaluator }}
              {{ form.evaluator.errors }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.evaluation_date.label_tag }}
              {{ form.evaluation_date }}
              {{ form.evaluation_date.errors }}
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>  {# /patientAccordion #}

  <button type="submit" class="btn btn-primary w-100 mt-3">保存</button>
</form>

{# 上传进度弹窗，阻塞页面操作 #}
<div class="modal fade" id="uploadProgressModal" tabindex="-1" role="dialog"
     aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title mb-0">正在上传文件...</h6>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div id="uploadProgressBar"
               class="progress-bar"
               role="progressbar"
               style="width: 0%;">
            0%
          </div>
        </div>
        <small class="text-muted d-block mt-2">
          如果存在待上传文件，本窗口会一直打开直到上传完成。
        </small>
      </div>
    </div>
  </div>
</div>

  <!-- jQuery (local) -->
  <script src="{% static 'js/jquery.min.js' %}"></script>

  <!-- Popper.js (local) -->
  <script src="{% static 'js/popper.min.js' %}"></script>

  <!-- Bootstrap JS (local) -->
  <script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>

<script>
(function() {
  var form = document.querySelector("#patientAccordion");
  if (!form) return;
  form = form.closest("form");
  if (!form) return;

  //========= 工具函数 =========//
  function hasFilesToUpload() {
    var names = ["mri_files", "pet_files", "eeg_files", "seeg_files"];
    for (var i = 0; i < names.length; i++) {
      var input = form.querySelector('input[name="' + names[i] + '"]');
      if (input && input.files && input.files.length > 0) {
        return true;
      }
    }
    return false;
  }

  //========= “添加文件” 按钮：触发隐藏的 <input type="file"> =========//
  form.querySelectorAll(".js-add-file-btn").forEach(function(btn) {
    btn.addEventListener("click", function() {
      var sel = btn.getAttribute("data-input-selector");
      var input = form.querySelector(sel);
      if (input) {
        input.click();
      }
    });
  });

  //========= 文件 input 变更时，在表格中增加“待上传”行 =========//
  function bindFileInput(fieldType) {
    var inputName = fieldType + "_files";
    var input = form.querySelector('input[name="' + inputName + '"]');
    var tbody = form.querySelector('tbody[data-file-type="' + fieldType + '"]');
    if (!input || !tbody) return;

    input.addEventListener("change", function() {
      var files = Array.from(input.files || []);
      if (!files.length) return;

      var emptyRow = tbody.querySelector(".js-empty-row");
      if (emptyRow) {
        emptyRow.parentNode.removeChild(emptyRow);
      }

      files.forEach(function(f) {
        var tr = document.createElement("tr");
        tr.setAttribute("data-new-file", "1");
        tr.innerHTML =
          "<td>" + f.name + "</td>" +
          "<td>待上传</td>" +
          "<td>—</td>" +
          '<td><button type="button" class="btn btn-sm btn-outline-danger js-row-remove">删除</button></td>';
        tbody.appendChild(tr);
      });
    });
  }

  ["mri", "pet", "eeg", "seeg"].forEach(bindFileInput);

  //========= 点击“删除”按钮：对已有文件记录，记入隐藏字段；对新文件直接移除行 =========//
  form.addEventListener("click", function(evt) {
    var target = evt.target;
    if (!target.classList.contains("js-row-remove")) return;

    var tr = target.closest("tr");
    if (!tr) return;

    var fileId = tr.getAttribute("data-file-id");
    var tbody = tr.closest("tbody");
    var type = tbody ? tbody.getAttribute("data-file-type") : null;

    // 已存在的文件（数据库中已有），记录到 delete_xxx_file_ids
    if (fileId && type) {
      var hiddenName = "delete_" + type + "_file_ids";
      var hidden = form.querySelector('input[name="' + hiddenName + '"]');
      if (hidden) {
        var current = hidden.value ? hidden.value.split(",") : [];
        if (current.indexOf(fileId) === -1) {
          current.push(fileId);
        }
        hidden.value = current.join(",");
      }
    }

    // 从表格中移除行
    tr.parentNode.removeChild(tr);
  });

  //========= 表单提交：统一走 XHR；如有文件则弹出进度条窗口 =========//
  form.addEventListener("submit", function(evt) {
    evt.preventDefault();

    var hasFiles = hasFilesToUpload();
    var modalEl = document.getElementById("uploadProgressModal");
    var progressBar = document.getElementById("uploadProgressBar");

    // 有待上传文件 -> 弹出阻塞窗口
    if (hasFiles && modalEl && typeof $ !== "undefined" && $.fn.modal) {
      $(modalEl).modal("show");
      if (progressBar) {
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
      }
    }

    var xhr = new XMLHttpRequest();
    xhr.open(form.method || "POST", form.action);
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

    xhr.upload.addEventListener("progress", function(e) {
      if (!hasFiles || !e.lengthComputable || !progressBar) return;
      var percent = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = percent + "%";
      progressBar.textContent = percent + "%";
    });

    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) return;

      if (hasFiles && modalEl && typeof $ !== "undefined" && $.fn.modal) {
        $(modalEl).modal("hide");
      }

      if (xhr.status >= 200 && xhr.status < 300) {
        var data = {};
        try {
          data = JSON.parse(xhr.responseText || "{}");
        } catch (e) {}

        if (data.success) {
          // 如果外层页面定义了关闭抽屉的回调，就调用；否则直接刷新
          if (window.onPatientFormSaved) {
            window.onPatientFormSaved();
          } else {
            window.location.reload();
          }
        } else {
          alert("保存失败，请检查表单错误。");
        }
      } else {
        alert("上传失败，HTTP 状态码: " + xhr.status);
      }
    };

    var formData = new FormData(form);
    xhr.send(formData);
  });
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const boxes = Array.from(document.querySelectorAll('input[name="eeg_interictal_location"]'));
  if (!boxes.length) return;

  const wrapFocal = document.getElementById("wrap_eeg_interictal_focal_lobe");
  const wrapLat = document.getElementById("wrap_eeg_interictal_laterality");

  function toggle() {
    const hasFocal = boxes.some(cb => cb.checked && cb.value === "FOCAL");
    const hasLat = boxes.some(cb => cb.checked && cb.value === "LAT");

    if (wrapFocal) wrapFocal.style.display = hasFocal ? "" : "none";
    if (wrapLat) wrapLat.style.display = hasLat ? "" : "none";
  }

  boxes.forEach(cb => cb.addEventListener("change", toggle));
  toggle();
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  function bindShowWhenRelated(selectId, wrapId) {
    const sel = document.getElementById(selectId);
    const wrap = document.getElementById(wrapId);
    if (!sel || !wrap) return;

    function isRelated() {
      const opt = sel.options[sel.selectedIndex];
      const val = (sel.value || "").trim();
      const text = (opt ? opt.textContent : "").trim();
      return val === "RELATED_CHANGE" || text === "相关改变";
    }

    function toggle() {
      wrap.style.display = isRelated() ? "" : "none";
    }

    sel.addEventListener("change", toggle);
    toggle();
  }

  bindShowWhenRelated("id_eeg_hv_result", "wrap_hv_related_change");
  bindShowWhenRelated("id_ips_result", "wrap_ips_related_change");
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const boxes = Array.from(
    document.querySelectorAll('input[name="eeg_ictal_location"]')
  );
  if (!boxes.length) return;

  const wrapFocal = document.getElementById("wrap_eeg_ictal_focal_lobe");
  const wrapLat = document.getElementById("wrap_eeg_ictal_laterality");

  function toggle() {
    const hasFocal = boxes.some(
      cb => cb.checked && cb.value === "FOCAL"
    );
    const hasLat = boxes.some(
      cb => cb.checked && cb.value === "LAT"
    );

    if (wrapFocal) wrapFocal.style.display = hasFocal ? "" : "none";
    if (wrapLat) wrapLat.style.display = hasLat ? "" : "none";
  }

  boxes.forEach(cb => cb.addEventListener("change", toggle));
  toggle(); // 页面加载时同步一次
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const sel  = document.getElementById('id_neuro_exam');
  const wrap = document.getElementById('wrap_neuro_exam_desc');
  if (!sel || !wrap) return;

  function isAbnormal() {
    const v = (sel.value || '').trim();
    const t = (sel.options[sel.selectedIndex]?.textContent || '').trim();
    return v === 'ABNORMAL' || t === '异常';
  }

  function toggle() {
    wrap.style.display = isAbnormal() ? '' : 'none';

    // 可选：隐藏时清空，避免误保存
    if (!isAbnormal()) {
      const textarea = document.getElementById('id_neuro_exam_description');
      if (textarea) textarea.value = '';
    }
  }

  sel.addEventListener('change', toggle);
  toggle(); // 初始化跑一次（编辑页如果已有值也能正确显示）
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const boxes = Array.from(
    document.querySelectorAll('input[name="past_medical_history"]')
  );
  const wrap = document.getElementById("wrap_pmh_other_text");
  const input = document.getElementById("id_past_medical_history_other_text");

  if (!boxes.length || !wrap) return;

  function toggleOtherText() {
    const hasOther = boxes.some(cb => cb.checked && cb.value === "OTHER");
    wrap.style.display = hasOther ? "" : "none";
    if (!hasOther && input) input.value = "";
  }

  boxes.forEach(cb => cb.addEventListener("change", toggleOtherText));
  toggleOtherText(); // 页面初始化时检查一次
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const auraSel = document.getElementById("id_aura");
  const wrap = document.getElementById("wrap_aura_text");
  const input = document.getElementById("id_aura_text");
  if (!auraSel || !wrap) return;

  function isAuraYes() {
    const val = (auraSel.value || "").trim();
    const opt = auraSel.options[auraSel.selectedIndex];
    const text = (opt ? opt.textContent : "").trim();
    return val === "YES" || text === "有";
  }

  function toggleAuraText() {
    const show = isAuraYes();
    wrap.style.display = show ? "" : "none";
    if (!show && input) input.value = "";
  }

  auraSel.addEventListener("change", toggleAuraText);
  toggleAuraText(); // 初始化
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const sel = document.getElementById("id_assessment_done");
  const wrap = document.getElementById("wrap_assessment_scores");
  if (!sel || !wrap) return;

  function toggle() {
    wrap.style.display = sel.value === "YES" ? "" : "none";
  }

  sel.addEventListener("change", toggle);
  toggle();
});
</script>
